{
  "hash": "2958bf8f09a5e30e1785863cfbb27721",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"lab 4\"\nauthor: \"Liz Gibbons\"\ndate: \"2024-04-12\"\noutput: html_document\neval: false\ncategories:\n  - lab\n  - bios25328\n---\n\n\n\n\n\n## Goals and Introduction\n\nIn this lab we are going to use the PRSice software to take height GWAS results and predict height of the Personal Genome Project individuals using their genotype data.\n\n### Goals\n\n-   Download data from box\n-   Download PRSice\n-   Run exploratory analysis of data\n-   Run PRSice\n-   Plot observed versus predicted for height\n\n## Setup\n\n### load R packages and define paths\n\nYou will have to install all these packages first:\n\n(r code block)\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages(\"tidyverse\")\ninstall.packages(\"RSQLite\")\ninstall.packages(\"glue\")\n```\n:::\n\n\n\n(r code block)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsuppressMessages(library(tidyverse))\nsuppressMessages(library(RSQLite))\nsuppressMessages(library(glue))\n```\n:::\n\n\n\n### Download data\n\n-   download the data from here and place it in a directory called DATA\n-   download PRSice software from <https://choishingwan.github.io/PRSice/>\n\nIf you are on a Mac install the mac appropriate binary:\n\n(bash code block)\n\n\n::: {.cell}\n\n```{.bash .cell-code}\n# wget https://github.com/choishingwan/PRSice/releases/download/2.3.5/PRSice_mac.zip\n```\n:::\n\n\n\nIf you are on Posit cloud do the linux binary:\n\n(bash code block)\n\n\n::: {.cell}\n\n```{.bash .cell-code}\nwget https://github.com/choishingwan/PRSice/releases/download/2.3.5/PRSice_linux.zip\n```\n:::\n\n\n\nUnzip the binary:\n(bash code block)\n\n\n::: {.cell}\n\n```{.bash .cell-code}\nunzip ./PRSice_linux.zip\n```\n:::\n\n\n\nmove the executable to the directory where you keep your software (optional) \\*\\* the first time you run PRSice, it will install additional components make sure PRSice is executable \\*\\* chmod u+x PRSice\n\n(bash code block)\n\n\n::: {.cell}\n\n```{.bash .cell-code}\nchmod +x ./PRSice_linux\n```\n:::\n\n\n\nTerminal Setup\n\n(bash code block)\n\n\n::: {.cell}\n\n```{.bash .cell-code}\nexport PRE=\"/cloud/project\"\nexport DATA=\"$PRE/Lab-personal-genomes-project-data\"\n\nexport PRSice=\"/cloud/project/\" # file/path/to/PRSice\nexport PRSice_os=\"PRSice_linux\" # optional: which operating system is your prsice named for\n#$PRSice/$PRSice_os --help\ncd $DATA\nexport WORK=$DATA\n```\n:::\n\n\n\n## Exploration of the Data\n\n### open the database with phenotype information and list tables\n\n(r code block)\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndbname <- paste0(DATA,\"/repgp-data.sqlite3\") ##This is just to create the file path to the sqlite3 file \n## connect to db\ndb = RSQLite::dbConnect(SQLite(), dbname)\n## list tables\ndbListTables(db)\n```\n:::\n\n\n\nquery database users table\n\n(r code block)\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndbListFields(db,\"users\")\n```\n:::\n\n\n\n(r code block)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nquery <- function(...) dbGetQuery(db, ...)\nusers = query(\"select * from users\")\nnames(users)\n```\n:::\n\n\n\nlook at distribution by count for each column\n\n(r code block)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nusers %>% count(race)\n```\n:::\n\n\n\n(r code block)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nusers  %>% count(gender)\n```\n:::\n\n\n\n(r code block)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nusers %>% count(blood)\n```\n:::\n\n\n\nplot height distribution by gender\n\n(r code block)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nusers %>% ggplot(aes(height,fill=gender)) + geom_density(alpha=0.6) + ggtitle(\"Height by gender - Missing gender, *, has bi-modal distr.\") + theme_minimal(base_size = 15)\n```\n:::\n\n\n\n## run PRSice\n\n### create phenotype data file\n\ncreate phenotype data file as intersection of the plink formatted fam file and the users table from the database repgp-data.sqlite3\n\n(r code block)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfam = read_tsv(glue::glue(\"{DATA}/repgp.fam\"),col_names = FALSE)\n```\n:::\n\n\n\n(r code block)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnames(fam)[1:2] = c(\"FID\",\"IID\")\nfam <- fam %>% select(FID, IID) %>% inner_join(users %>% select(sample,height,weight,gender), by=c(\"IID\"=\"sample\")) \nwrite_tsv(fam,file=glue::glue(\"{DATA}/phenodata.txt\"))\n```\n:::\n\n\n\nexecute bash command to run PRSice\n\n(bash code block)\n\n\n::: {.cell}\n\n```{.bash .cell-code}\nmkdir /cloud/project/Lab-personal-genomes-project-data/output\n\nRscript /cloud/project/PRSice.R --dir /cloud/project \\\n    --prsice /cloud/project/PRSice_linux \\\n    --base /cloud/project/Lab-personal-genomes-project-data/ukb_height.gz \\\n    --target cloud/project/Lab-personal-genomes-project-data/repgp.chr# \\\n    --snp variant_id \\\n    --A1 effect_allele \\\n    --A2 non_effect_allele \\\n    --stat effect_size \\\n    --beta \\\n    --pvalue pvalue \\\n    --pheno-file /cloud/project/Lab-personal-genomes-project-data/phenodata.txt \\\n    --pheno-col height \\\n    --bar-levels 5e-08,5e-07,5e-06,5e-05,5e-04,5e-03,5e-02,5e-01,1 \\\n    --fastscore \\\n    --binary-target F \\\n    --thread 2 \\\n    --out /cloud/project/Lab-personal-genomes-project-data/output/height_score_all\n```\n:::\n\n\n\nIf you get duplicated SNP ID, follow the instructions\n\n(bash code block)\n\n\n::: {.cell}\n\n```{.bash .cell-code}\nPRSice=\"/cloud/project/\"\nWORK=\"/cloud/project/Lab-personal-genomes-project-data/\"\n\nRscript $PRSice/PRSice.R --dir $PRSice \\\n    --prsice $PRSice/PRSice_mac \\\n    --base $WORK/ukb_height.gz \\\n    --extract $WORK/output/height_score_all.valid \\\n    --target $WORK/repgp.chr# \\\n    --snp variant_id \\\n    --A1 effect_allele \\\n    --A2 non_effect_allele \\\n    --stat effect_size \\\n    --beta \\\n    --pvalue pvalue \\\n    --pheno-file $WORK/phenodata.txt \\\n    --pheno-col height \\\n    --bar-levels 5e-08,5e-07,5e-06,5e-05,5e-04,5e-03,5e-02,5e-01,1 \\\n    --fastscore \\\n    --binary-target F \\\n    --thread 2 \\\n    --out $WORK/output/height_score_all\n```\n:::\n\n\n\nThis may take a couple minutes\n\nplot observed vs predicted height\n\n(r code block)\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## we already have the phenotype data in the fam variable\npredicted_height = read_delim(glue::glue(\"{DATA}/output/height_score_all.best\"),delim=\" \")\n```\n:::\n\n\n\n(r code block)\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncombined <- predicted_height %>% inner_join(fam,by=c(\"IID\"=\"IID\")) \ncombined %>% ggplot(aes(PRS,height)) + geom_point() + theme_minimal(base_size = 15)\n```\n:::\n\n\n\nregress observed height with predicted height (PRS)\n\n(r code block)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(lm(height ~ PRS,data=combined)) %>% coef() \n```\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}